# Logstash Configuration for CosmosBuilder
input {
  # Filebeat input for log files
  beats {
    port => 5044
  }
  
  # HTTP input for application logs
  http {
    port => 8080
    codec => json
  }
  
  # TCP input for direct log streaming
  tcp {
    port => 5000
    codec => json_lines
  }
}

filter {
  # Parse application logs
  if [fields][service] == "cosmosbuilder" {
    # Parse JSON logs from application
    if [message] =~ /^[\{\[]/ {
      json {
        source => "message"
      }
    }
    
    # Parse structured text logs
    grok {
      match => { 
        "message" => "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:level} %{DATA:logger} - %{GREEDYDATA:message}"
      }
    }
    
    # Add timestamp
    date {
      match => [ "timestamp", "ISO8601" ]
    }
    
    # Categorize by log level
    if [level] == "ERROR" {
      mutate {
        add_tag => [ "alert", "error" ]
      }
    } else if [level] == "WARN" {
      mutate {
        add_tag => [ "warning" ]
      }
    }
    
    # Extract chain ID from logs
    if [message] =~ /chain[_\-]?id/i {
      grok {
        match => { "message" => "chain[_\-]?id[=:\s]+([a-zA-Z0-9_\-]+)" }
        add_field => { "chain_id" => "%{GLOBAL:grok_match.1}" }
      }
    }
    
    # Extract user ID from logs
    if [message] =~ /user[_\-]?id/i {
      grok {
        match => { "message" => "user[_\-]?id[=:\s]+([a-zA-Z0-9_\-]+)" }
        add_field => { "user_id" => "%{GLOBAL:grok_match.1}" }
      }
    }
  }
  
  # Parse access logs
  if [fields][logtype] == "access" {
    grok {
      match => { 
        "message" => "%{NGINXACCESS}" 
      }
    }
    
    # Add geolocation data (requires geoip database)
    if [clientip] {
      geoip {
        source => "clientip"
        target => "geoip"
      }
    }
  }
  
  # Parse error logs
  if [fields][logtype] == "error" {
    grok {
      match => { 
        "message" => "%{NGINXERROR}" 
      }
    }
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "cosmosbuilder-%{+YYYY.MM.dd}"
    template_name => "cosmosbuilder"
    template_pattern => "cosmosbuilder-*"
    template => "/etc/logstash/templates/cosmosbuilder-template.json"
  }
  
  # Debug output (remove in production)
  # stdout { codec => rubydebug }
  
  # Conditional outputs based on tags
  if "alert" in [tags] {
    http {
      url => "http://alertmanager:9093/api/v1/alerts"
      http_method => "post"
      format => "json"
      mapping => {
        "alerts" => [{
          "labels" => {
            "alertname" => "LogAlert"
            "severity" => "critical"
            "service" => "cosmosbuilder"
          }
          "annotations" => {
            "summary" => "Critical log message detected"
            "description" => "%{message}"
          }
        }]
      }
    }
  }
}